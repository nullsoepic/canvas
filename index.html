<!DOCTYPE html>
<html>
    <head>
        <title>Canvas</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
                background: #0c0c0d;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }
            canvas {
                display: block;
                width: 1024px;
                height: 1024px;
                image-rendering: pixelated;
            }
            .docs-link {
                position: absolute;
                bottom: 20px;
                left: 20px;
                color: #2a2a2b;
                text-decoration: none;
                font-family: sans-serif;
            }
            .docs-link:hover {
                color: #3a3a3b;
            }
        </style>
    </head>
    <body>
        <canvas id="canvas" width="512" height="512"></canvas>
        <a href="/docs" class="docs-link">Documentation</a>
        <script>
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "#0c0c0d";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const ws = new WebSocket("wss://" + window.location.host + "/ws");
            ws.binaryType = 'arraybuffer';
            
            ws.onmessage = function (event) {
                if (event.data instanceof ArrayBuffer) {
                    const data = new Uint8Array(event.data);
                    const msgType = data[0];
                    let offset = 1;
                    if (msgType === 0x00) { // Pixel update batch
                        const n = (data[offset] << 8) | data[offset + 1];
                        offset += 2;
                        for (let i = 0; i < n; i++) {
                            if (offset + 7 > data.length) break;
                            const x = (data[offset] << 8) | data[offset + 1];
                            const y = (data[offset + 2] << 8) | data[offset + 3];
                            const r = data[offset + 4];
                            const g = data[offset + 5];
                            const b = data[offset + 6];
                            offset += 7;
                            ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                            ctx.fillRect(x, y, 1, 1);
                        }
                    } else if (msgType === 0x01) { // Initial canvas data chunk
                        const n = (data[offset] << 8) | data[offset + 1];
                        offset += 2;
                        for (let i = 0; i < n; i++) {
                            if (offset + 7 > data.length) break;
                            const x = (data[offset] << 8) | data[offset + 1];
                            const y = (data[offset + 2] << 8) | data[offset + 3];
                            const r = data[offset + 4];
                            const g = data[offset + 5];
                            const b = data[offset + 6];
                            offset += 7;
                            ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                            ctx.fillRect(x, y, 1, 1);
                        }
                    }
                }
            };
        </script>
    </body>
</html>